import requests
import pandas as pd
import matplotlib.pyplot as plt
from dataclasses import dataclass
from enum import Enum
from typing import Optional

# --- 1. MOD√âLISATION (US-01) ---
class Standing(Enum):
    A_RENOVER = "√Ä r√©nover"
    STANDARD = "Standard"
    HAUT_DE_GAMME = "Haut de gamme"

@dataclass
class BienImmobilier:
    code_insee: str  # Important pour l'API DVF
    ville: str
    surface_habitable: float
    nombre_pieces: int
    standing: Standing

# --- 2. R√âCUP√âRATION DES DONN√âES (US-02) ---
def recuperer_transactions_dvf(code_insee: str):
    print(f"üîÑ Connexion √† la base DVF pour le code INSEE {code_insee}...")
    url = f"https://api.cquest.org/dvf?code_commune={code_insee}"
    
    try:
        response = requests.get(url, timeout=10)
        if response.status_code == 200:
            data = response.json()
            if 'features' not in data or not data['features']:
                return pd.DataFrame()

            transactions = [item['properties'] for item in data['features']]
            df = pd.DataFrame(transactions)
            
            # Filtrage basique
            df = df[df['nature_mutation'] == 'Vente']
            df = df[df['type_local'].isin(['Maison', 'Appartement'])]
            
            # S√©lection et conversion
            colonnes = ['date_mutation', 'valeur_fonciere', 'surface_reelle_bati']
            df = df[colonnes].copy() # On travaille sur une copie propre
            df['date_mutation'] = pd.to_datetime(df['date_mutation'])
            df['valeur_fonciere'] = pd.to_numeric(df['valeur_fonciere'])
            df = df[df['surface_reelle_bati'] > 0] # S√©curit√© division par z√©ro
            
            print(f"‚úÖ {len(df)} ventes trouv√©es sur les 5 derni√®res ann√©es.")
            return df
        return pd.DataFrame()
    except Exception as e:
        print(f"‚ùå Erreur de connexion : {e}")
        return pd.DataFrame()

# --- 3. ANALYSE ET VISUALISATION (US-03) ---
def analyser_marche(df: pd.DataFrame):
    if df.empty:
        return 0.0

    # Calcul du prix au m¬≤
    df['prix_m2'] = df['valeur_fonciere'] / df['surface_reelle_bati']
    
    # Moyenne globale (pour l'estimation)
    prix_moyen_global = df['prix_m2'].mean()
    
    # Pr√©paration du graphique
    df['annee'] = df['date_mutation'].dt.year
    evolution = df.groupby('annee')['prix_m2'].mean().sort_index()
    
    # Affichage du graphique
    plt.figure(figsize=(10, 5))
    plt.plot(evolution.index, evolution.values, marker='o', color='#3498db', linewidth=2)
    plt.title(f"√âvolution du prix au m¬≤ (Moyenne : {int(prix_moyen_global)}‚Ç¨)", fontsize=12)
    plt.grid(True, linestyle='--', alpha=0.5)
    plt.ylabel("Prix ‚Ç¨/m¬≤")
    
    # On affiche le graphique sans bloquer le script compl√®tement (mode interactif si besoin)
    print("üìä G√©n√©ration du graphique d'√©volution...")
    plt.show() 
    
    return prix_moyen_global

# --- 4. C≈íUR DU PROGRAMME (ORCHESTRATION) ---
def main():
    print("=== üè° ESTIMATEUR IMMOBILIER (MVP) ===")
    
    # -- A. Saisie Utilisateur (Simul√©e ou r√©elle) --
    # Pour le test, on prend Bordeaux (33063)
    input_ville = "Bordeaux"
    input_insee = "33063" 
    input_surface = 75.0
    input_pieces = 3
    input_standing = Standing.STANDARD

    mon_bien = BienImmobilier(input_insee, input_ville, input_surface, input_pieces, input_standing)
    
    print(f"\n1Ô∏è‚É£ Bien identifi√© : {mon_bien.ville} | {mon_bien.surface_habitable}m¬≤ | {mon_bien.standing.value}")

    # -- B. R√©cup√©ration Data --
    df_transactions = recuperer_transactions_dvf(mon_bien.code_insee)
    
    if df_transactions.empty:
        print("‚ùå Pas assez de donn√©es pour faire une estimation fiable.")
        return

    # -- C. Analyse & Visuel --
    prix_moyen_m2 = analyser_marche(df_transactions)

    # -- D. Estimation Finale --
    # Formule simple : Surface * Prix moyen (Ajustable selon le standing plus tard)
    estimation_brute = prix_moyen_m2 * mon_bien.surface_habitable
    
    print("\n" + "="*40)
    print(f"üí∞ R√âSULTAT DE L'ESTIMATION")
    print(f"Prix moyen secteur : {int(prix_moyen_m2)} ‚Ç¨/m¬≤")
    print(f"Valeur estim√©e     : {int(estimation_brute):,} ‚Ç¨")
    print("="*40 + "\n")

if __name__ == "__main__":
    main()
